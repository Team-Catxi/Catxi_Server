# CATXI 프로젝트 주요 이슈 및 해결 과정

## 1. 아키텍처 문제점 및 분석

### 문제 상황
- **SPOF (Single Point of Failure)**: EC2 #1이 Nginx, Redis, Chat Server 등 너무 많은 책임을 가지고 있어 장애 발생 시 전체 시스템에 영향을 미칩니다.
- **Redis Pub/Sub 미작동**: `ip_hash` 로드밸런싱 방식 때문에 사용자가 특정 서버에 고정되어, 다른 서버로 메시지가 전파되어야 하는 Pub/Sub 모델이 제대로 동작하지 않았습니다.
- **비효율적인 부하 분산**: `ip_hash`는 실제 서버 부하를 고려하지 않고 IP 기준으로만 트래픽을 분배하여 서버 간 부하 불균형을 초래합니다.
- **제한적인 확장성**: 현재 구조는 수직적 확장에 의존하며, 트래픽에 따른 탄력적 확장이 어렵습니다.

### 해결 방안
- **Nginx 로드밸런싱 변경**: `ip_hash`에서 `least_conn` 방식으로 변경하여 실제 연결이 가장 적은 서버로 트래픽을 보내 동적 부하 분산을 구현합니다.
- **Redis 외부화**: EC2 인스턴스에서 관리하던 Redis를 **AWS ElastiCache**로 이전하여 SPOF를 제거하고, 관리 효율성과 안정성을 높입니다.
- **역할의 명확한 분리**: 각 EC2 인스턴스가 게이트웨이, 비즈니스 로직, 실시간 통신 등 단일 책임을 갖도록 아키텍처를 재구성하여 결합도를 낮춥니다.

---

## 2. 데이터베이스 마이그레이션 전략 부재

### 문제 상황
- 수동으로 DB 스키마를 변경하면서 발생하는 휴먼 에러로 인해 배포 시 장애가 발생했습니다.
- 여러 개발자가 작업할 때 DB 스키마 버전이 일치하지 않는 문제가 있었습니다.

### 해결 방안
- **Flyway 도입**: DB 마이그레이션 관리 도구인 Flyway를 도입하여 스키마 변경을 코드로 관리하고 자동화합니다.
- **CI/CD 파이프라인에 통합**: Jenkins 배포 파이프라인에 Flyway 마이그레이션 검증 단계를 추가하여, 배포 전에 스키마 변경이 안전하게 적용되는지 자동으로 확인합니다.
- **상태 모니터링**: Flyway 마이그레이션 상태를 확인할 수 있는 API 엔드포인트를 만들어 `actuator/health`와 같이 지속적으로 모니터링합니다.

---

## 3. 크로스 서버 채팅 시나리오

### 문제 상황
`ip_hash`로 인해 사용자 A와 사용자 B가 서로 다른 채팅 서버에 접속했을 때, 한쪽에서 보낸 메시지가 다른 쪽으로 전달되지 않았습니다.

### 해결 과정: Redis Pub/Sub 재구현
1. **메시지 발행 (Publish)**
   - 사용자 A가 서버1에 연결된 상태에서 메시지를 보냅니다.
   - 서버1은 받은 메시지를 Redis의 `chat` 채널로 발행(Publish)합니다.

2. **메시지 구독 (Subscribe)**
   - **모든 채팅 서버(서버1, 서버2 등)** 는 `chat` 채널을 구독(Subscribe)하고 있습니다.
   - Redis는 `chat` 채널에 발행된 메시지를 모든 구독자(모든 채팅 서버)에게 전송합니다.

3. **클라이언트에게 전송**
   - 서버1은 Redis로부터 받은 메시지를 자신에게 연결된 채팅방 참여자들에게 STOMP/WebSocket을 통해 전송합니다.
   - 서버2 또한 Redis로부터 동일한 메시지를 받아, 자신에게 연결된 채팅방 참여자(사용자 B 포함)에게 메시지를 전송합니다.

이를 통해 어떤 서버에 접속해 있더라도 모든 사용자가 실시간으로 메시지를 주고받을 수 있게 됩니다.

